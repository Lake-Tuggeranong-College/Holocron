

# Edit Product Details

As with the majority of other sections of this project, this section could be achieved in a number of different approaches. The approach taken here is to create a page that will generate and display a list of all the current products in the `Products` table. An example of this is shown here.

![[editProductsPage.png]]

Developing this page will allow the shown **Edit** button to load the Edit page, by passing a unique identifier to the product. This means that developing the Edit page will be easier as it only displays and saves the product details that is needed.

Additionally, this page can be expanded in the future by adding a link to remove individual products.

## List of Products

Create a new page in the main directory of the project called `productList.php`. Replace the default code with the project’s default code for new pages.

![[editProductsProductListPage.png]]

```php
<?php include "template.php";
/**  @var $conn */
?>
	<title>Product List</title>

	<h1 class='text-primary'>Product List</h1>
```

Have the page load some of the fields from the Products table. 

**Important**

The fields needed are dependent on the requirements of the project. The fields retrieved and **the order** in which they are retrieved will be required in the next step. 

In the case shown, the fields `ProductName`, `Image` and `Code` are retrieved. 

Later in the code, each row will be organised in an array, with `ProductName` having the index 0, `Image` with the index 1 and `Code` with the index 2.

![[editProductsRetrieveProductList.png]]

```php
<?php
$productList = $conn->query("SELECT ProductName, Image, Code FROM Products");
?>
```

Before generating the list of products for the user, first check if the user is an administrator. This is done the same way as other pages on the site. 

![[editProductsCheckPermissions.png]]

```php
<?php
// Check to see if User is Administrator (level 1)
// If they are, allow functionality, otherwise redirect them back to the front page.
if ($_SESSION['AccessLevel'] == 1) {
	?>
	<!--  Display a list of the products  -->

	<?php
} else {
	header("location:index.php");
}
?>
```

Assuming the user is an administrator, create a container to display the information required. 

When developing the page there is no knowledge of how many entries will need to be displayed, so a loop is required. In this case a `while` loop is arguably most appropriate.

![[editProductsAdminLoop.png]]

```php
<div class="container-fluid">
		<?php
		while ($productData = $productList->fetchArray()) {
			?>
			<!-- Display each product as [Image] [ProductName] [Edit Link]-->
			<?php
		}
		?>
	</div>
```

For each product, create a row, and three columns. The columns should display:

1. The image (filename is stored in `$productData[1]`)
2. The Product Name - `$productData[0]`.
3. An Edit Link including the product’s Code - `$productData[2]`.

The Edit link includes a reference to the page `productEdit.php` which has not been created as yet. However, the link also includes a variable called `prodCode` which is passed to the `productEdit.php` page. 

The url generated by this code will appear similar to this:

`http://localhost:63342/SDF-PHP2023/productEdit.php?prodCode=M3478D`

The `prodCode` variable will be the code entered when the product is added to the table. 

This variable will be used by the `productEdit.php` page to load the specific product details required.

![[editProductsAdminLoopDetails.png]]

```php
<div class="row">
	<div class="col-md-2">
		<?php
		echo '<img src="images/productImages/' . $productData[1] . '" width="50" height="50">';
		?>
	</div>
	<div class="col-md-4">
		<?php echo $productData[0]; ?>
	</div>
	<div class="col-md-2">
		<!--            edit button-->
		<a href="productEdit.php?prodCode=<?php echo $productData[2]; ?>">Edit</a>
	</div>
</div>
```

## Edit Product

Create the `productEdit.php` page in the main directory. Replace the default code with code to get the URL parameter `prodCode` and load the relevant record from the product table.

Then, extract all the fields into individual variables to display in the form.

![[editProductsIndividualPage.png]]

```php
<?php include "template.php";
/**  @var $conn */
?>
<title>Edit Product</title>
<?php

if (isset($_GET["prodCode"])) {
	$prodCode = $_GET["prodCode"];
		$query = $conn->query("SELECT DISTINCT category FROM Products");
} else {
	header("location:index.php");
}

$query = $conn->query("SELECT * FROM products WHERE code='$prodCode'");
$prodData = $query->fetchArray();
$prodName = $prodData[1];
$prodPrice = $prodData[2];
$prodCategory = $prodData[3];
$prodQuantity = $prodData[4];
$prodImage = $prodData[5];
?>

<h1 class='text-primary'>Edit Product - <?= $prodName ?></h1>
```

Include the code to first confirm the user is an administrator, otherwise redirect them back to the home page.

![[editProductsReturntoMain.png]]

```php
<?php
// Check to see if User is Administrator (level 1)
// If they are, allow functionality, otherwise redirect them back to the front page.
if ($_SESSION['AccessLevel'] == 1) {
	?>

	<?php
} else {
	header("location:index.php");
}
?>
```

The displayed form will be extremely similar as the form to collect the data to add products - in `productAdd.php` - however this form will also pre-populate the form input boxes with the existing data from the SQL query.

If the user **is** an administrator, display the form filling in the details for the product.


> [!info] You may notice that the only change made to the Product Add form is the inclusion of the `value` attribute for each input box and the image being displayed.



![[editProductsPrePopulateForm.png]]

```php
<form action="productEdit.php?prodCode=<?= $prodCode ?>" method="post" enctype="multipart/form-data">
	<div class="container-fluid">
		<div class="row">
			<!--Customer Details-->
			<div class="col-md-6">
				<h2>Products Details</h2>
				<p>Product Name<input type="text" name="prodName" class="form-control" required="required"
									  value="<?= $prodName ?>"></p>
				<p>Product Category
					<input type="text" name="prodCategory" class="form-control" required="required"
						   value="<?= $prodCategory ?>"></p>
				</p>
				<p>Quantity<input type="number" name="prodQuantity" class="form-control" required="required"
								  value="<?= $prodQuantity ?>"></p>
			</div>
			<div class="col-md-6">
				<h2>More Details</h2>
				<!--Product List-->
				<p>Price<input type="number" step="0.01" name="prodPrice" class="form-control" required="required"
							   value="<?= $prodPrice ?>">
				</p>
				<p>Product Code<input type="text" name="prodCode" class="form-control" required="required"
									  value="<?= $prodCode ?>"></p>
				<p>Product Picture
					<img src='images/productImages/<?= $prodImage ?>' width='100' height='100'>
					<input type="file" name="prodImage" class="form-control" required="required"></p>
			</div>
		</div>
	</div>
	<input type="submit" name="formSubmit" value="Submit">
</form>
```

Once the form has been submitted, the code required to update the record in the database is extremely similar to the code to add a new record.

The primary difference is the SQL statement is an `UPDATE` query rather than an `INSERT` query.

```php
<?php
// Back End
if ($_SERVER["REQUEST_METHOD"] == "POST") {
//    Customer Details
	$newName = sanitiseData($_POST['prodName']);
	$newCategory = sanitiseData($_POST['prodCategory']);
	$newQuantity = sanitiseData($_POST['prodQuantity']);
	$newPrice = sanitiseData($_POST['prodPrice']);
	$newCode = sanitiseData($_POST['prodCode']);

	// Image details
	$file = $_FILES['prodImage'];
	$fileName = $_FILES['prodImage']['name'];
	$fileTmpName = $_FILES['prodImage']['tmp_name'];
	$fileSize = $_FILES['prodImage']['size'];
	$fileError = $_FILES['prodImage']['error'];
	$fileType = $_FILES['prodImage']['type'];

	// defining what type of file is allowed
	// We separate the file, and obtain the file extension.
	$fileExtension = explode('.', $fileName);
	$fileActualExtension = strtolower(end($fileExtension));

	$allowedExtensions = array('jpg', 'jpeg', 'png', 'pdf');

	//We ensure the extension is allowable
	if (in_array($fileActualExtension, $allowedExtensions)) {
		if ($fileError === 0) {
			// File is smaller than arbitrary size
			if ($fileSize < 10000000000) {
				//file name is now a unique ID based on time with IMG- preceeding it, followed by the file type.
				$fileNameNew = uniqid('IMG-', True) . "." . $fileActualExtension;
				//upload location
				$fileDestination = 'images/productImages/' . $fileNameNew;
				// Upload file
				move_uploaded_file($fileTmpName, $fileDestination);

				// Write details to database
				$sql = "UPDATE Products SET ProductName= :newProdName, Category= :newProdCategory, Quantity= :newProdQuantity, Price= :newProdPrice, Image= :newProdImage, Code= :newProdCode WHERE code='$prodCode'";
				$stmt = $conn->prepare($sql);
				$stmt->bindValue(':newProdName', $newName);
				$stmt->bindValue(':newProdCategory', $newCategory);
				$stmt->bindValue(':newProdQuantity', $newQuantity);
				$stmt->bindValue(':newProdPrice', $newPrice);
				$stmt->bindValue(':newProdImage', $fileNameNew);
				$stmt->bindValue(':newProdCode', $newCode);
				$stmt->execute();
				header("location:productList.php");
			} else {
				echo "Your image is too big!";
			}
		} else {
			echo "there was an error uploading your image!";
		}
	} else {
		echo "You cannot upload files of this type!";
	}
}

?>
```

The page should now allow an administrator to make changes to individual product details. Try it and ensure it works.

![[editProductsFinalView.png]]
